<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Token Consumer Example</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.green-orange.min.css" />
  <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- Firebase Auth -->
  <script type="text/javascript">
    /**************************************************
     * TODO(DEVELOPER): Change these config variable. *
     **************************************************/
    var apiKey = 'YOUR_API_KEY_HERE';
    var databaseUrl = "YOUR_DATABASE_URL_HERE";
  </script>
  <script src="https://cdn.firebase.com/js/client/2.4.0/firebase.js"></script>
  <!--  We are including the firebase auth file manually, but in the
        future we will provide a full packaged version for use in production -->
  <script type="text/javascript" src="firebaseauth-min.js"></script>
  <script type="text/javascript">
    var app = null;
    var auth = null;

    /*
     * Handle the sign in button press.
     *
     * Sign in status persists between page reloads, so we check status using
     * |currentUser| on the Firebase auth object.
     *
     * auth.signOut clears the current session.
     *
     * auth.signInWithCustomToken takes the ID token we have generated from
     * our own authentication system and passes it to the Firebase Auth backend.
     * We can check for the result in the callback, or monitor the auth status
     * separately (see initApp for that part).
     */
    function handleSignIn(evt) {
      if (auth.currentUser()) {
        // [START signout]
        auth.signOut().then(function() {
          // Signout complete.
          console.log("Signed Out");
        }, function(error) {
          console.log("Sign Out Error", error);
        });
        // [END signout]
      } else {
        var token = document.getElementById('tokentext').value;
        if (token.length < 10) {
          alert("Please enter a token in the text area");
          return;
        }
        // Sign in with custom token generated following previous instructions.
        // [START authwithtoken]
        auth.signInWithCustomToken(token).then(function(user) {
          console.log("Sign In Success", user);
        }, function(error) {
          console.log("Sign In Error", error);
        });
        // [END authwithtoken]
      }
    }

    /**
     * initApp handles setting up the Firebase context and registering
     * callbacks for the auth status.
     *
     * The core initialization is in firebase.App - this is the glue class
     * which stores configuration. We provide an app name here to allow
     * distinguishing multiple app instances.
     *
     * This method also registers a listener with app.addAuthStateListener.
     * This listener is called when the user is signed in or out, and that
     * is where we update the UI.
     *
     * When signed in, we also authenticate to the Firebase Realtime Database.
     * In this alpha version of the library we do that by retrieving a token
     * from the Secure Token Service
     */
    function initApp() {
      console.log("Initializing App");
      // Check preconditions.
      if (databaseUrl.indexOf("firebaseio") < 0 || apiKey.indexOf("AI") < 0) {
        console.log("Enter your config values for apiKey and databaseUrl");
        alert("Enter your config values for apiKey and databaseUrl");
        return;
      }

      // [START appconfg]
      // Api key in config.
      var config = {
        apiKey: apiKey
      };
      app = firebase.App.initialize(config, "my app");
      auth = app.auth();
      // [END appconfig]

      console.log("Adding auth state listener");
      // Auth state changes.
      // [START authstatelistener]
      app.addAuthStateListener(function(event) {
        // Current user.
        var user = event.user;
        var getToken = event.getToken;
        console.log("User Object:", user);

        if (!user) {
          document.getElementById('signin').textContent = "Sign In";
          return;
        }
        document.getElementById('signin').textContent = "Sign Out";
        alert("Welcome UID:" + user.userId);

        // [START_EXCLUDE]
        // Get Secure Token Service token, pass true if you want to force refresh.
        getToken(false).then(function(response) {
          // As an example, authenticate to the database. This is using the
          // public Firebase.com SDK rather than the new firebase.google.com
          // library, so we have to call authWithCustomToken directly.
          // Future updates will handle this part automatically.
          var myFirebaseRef = new Firebase(databaseUrl);
          myFirebaseRef.authWithCustomToken(response.accessToken, function(error, authData) {
            if (error) {
              console.log("Database Auth Failed!", error);
            } else {
              console.log("Database Auth Succeeded!", authData);
              myFirebaseRef.on("value", function(snapshot) {
                console.log("Database snapshot:", snapshot.val());
              });
          }
          // [END_EXCLUDE]
        });
      }, function(error) {
        console.log("Auth Listener Error", error);
      });
      // [END authstatelistener]
  });

  document.getElementById("signin").addEventListener('click', handleSignIn, false)
}

window.onload = function() {
  var searchPath = "?tok=";
  var url = window.location.search;
  // Load the token from the URL if present.
  if (url.indexOf(searchPath) >= 0) {
    var token = url.substring(url.indexOf(searchPath) + searchPath.length);
    document.getElementById('tokentext').value = token;
  }
  initApp();
};
</script>
</head>
<body>
  <div class="mdl-layout" id="content">
    <header class="mdl-layout__header mdl-grid">
      <h1>Firebase Custom Authentication</h1>
    </header>
    <main class="mdl-layout__content">
      <div class="mdl-grid">
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-cell mdl-cell-8-col-tablet mdl-cell--8-col-desktop" >
          <p>Enter a custom token below. For testing, you can generate one with the <a href="exampletokengenerator/auth.html">example generator</a>, but you can also generate your token manually.</p>
        </div>
        <div class="mdl-layout-spacer"></div>
      </div>
      <div class="mdl-grid">
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-cell mdl-cell-8-col-tablet mdl-cell--8-col-desktop">
          <textarea id="tokentext" style="width: 100%; height: 200px;" name="tokentext" placeholder="Enter Your Custom Token"></textarea>
          <br />
          <button id="signin" name="signin">Sign In</button>
        </div>
        <div class="mdl-layout-spacer"></div>
      </div>
  </main>
  </div>
</body>
</html>
