<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--
    Note that Google Sign In does not work from a file URL. You will need to make
    this page available from a web server, either from localhost or using Firebase
    Hosting.

    Whichever domain it is running on, you'll have to add the origin for that domain
    in the Google Developer Console: https://console.developers.google.com, search
    for Credentials and create a new credential > OAuth client ID > web application,
    and set the domain as an authorised origin (e.g. http://localhost:8000 or https://foo.bar).
    -->
  <!-- [START google_config] -->
  <meta name="google-signin-scope" content="profile email">
  <!--
   * TODO(DEVELOPER): Change this config variable. *
   -->
  <meta name="google-signin-client_id" content="YOUR_CLIENT_ID_HERE">
  <meta name="google-signin-cookiepolicy" content="single_host_origin">
  <!-- [END google_config] -->
  <title>Google Sign In Example</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>

  <link rel="stylesheet" href="main.css">

  <!-- Google Sign In -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <!-- Firebase -->
  <!-- ************************************************************************************************
       * TODO(DEVELOPER): Paste the initialization snippet from: Firebase Console > Auth > WEB SETUP. *
       ************************************************************************************************ -->

  <script type="text/javascript">
    console.log('Initializing App');
    // [START appconfig]
    var app = firebase.app();
    var auth = app.auth();
    // [END appconfig]

    function onSignIn(googleUser) {
      // Keep track of the Google User so we can sign out of Google Login.
      window.googleUser = googleUser;

      // [START checksameuser]
      if (auth.currentUser) {
        // If we are already signed in with Google and Firebase,
        // check we're in a Firebase account associated with the same
        // Google account.
        var providerData = auth.currentUser.providerData;
        for (var key in providerData) {
          if (providerData[key].providerId === 'google.com') {
            var mungedId = 'https://accounts.google.com/' + googleUser.getBasicProfile().getId();
            if (providerData[key].uid == mungedId) {
              // We don't need to reauth the Firebase connection.
              return;
            }

          }
        }
      }
      // [END checksameuser]

      // [START googlecredential]
      // Sign in with credential from the Google user.
      var credential = firebase.auth.GoogleAuthProvider.credential(
          googleUser.getAuthResponse().id_token);
      // [END googlecredential]
      // [START authwithcred]
      auth.signInWithCredential(credential).then(function(user) {
        console.log('Sign In Success', user);
        document.getElementById('signout').disabled = false;
      }, function(error) {
        console.error('Sign In Error', error);
      });
      // [END authwithcred]
    }

    /*
     * Handle the sign in button press.
     *
     * Sign in status persists between page reloads, so we check status using
     * |currentUser| on the Firebase auth object.
     *
     * auth.signOut clears the current session.
     */
    function handleSignOut() {
      if (auth.currentUser) {
        // [START signout]
        auth.signOut().then(function() {
          // Firebase Signout complete.
          window.googleUser.disconnect();
          document.getElementById('signout').disabled = true;
          console.log('Signed Out');
        }, function(error) {
          console.error('Sign Out Error', error);
        });
        // [END signout]
      }
    }

    /**
     * initApp handles setting up the Firebase context and registering
     * callbacks for the auth status.
     *
     * The core initialization is in firebase.App - this is the glue class
     * which stores configuration. We provide an app name here to allow
     * distinguishing multiple app instances.
     *
     * This method also registers a listener with auth.onAuthStateChanged.
     * This listener is called when the user is signed in or out, and that
     * is where we update the UI.
     *
     * When signed in, we also authenticate to the Firebase Realtime Database.
     */
    function initApp() {

      console.log('Adding auth state listener');
      // Auth state changes.
      // [START authstatelistener]
      auth.onAuthStateChanged(function(user){
        console.log('User Object:', user);

        if (!user) {
          document.getElementById('signout').disabled = true;
          return;
        }
        document.getElementById('signout').disabled = false;
        alert('Welcome UID:' + user.uid);

        // [START_EXCLUDE]
        var myFirebaseRef = app.database().ref();
        myFirebaseRef.on('value', function(snapshot) {
          console.log('Database snapshot:', snapshot.val());
        });
        // [END_EXCLUDE]
      }, function(error) {
        console.error(error);
      });
      // [END authstatelistener]

      document.getElementById('signout').addEventListener('click', handleSignOut, false);
    }

    window.onload = function() {
      initApp();
    };
  </script>
</head>
<body>
<div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-header">

    <!-- Header section containing title -->
    <header class="mdl-layout__header mdl-color-text--white mdl-color--primary">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">
            <div class="mdl-layout__header-row mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--8-col-desktop">
                <h3>Firebase Authentication</h3>
            </div>
        </div>
    </header>

    <main class="mdl-layout__content mdl-color--grey-100">
        <div class="mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-grid">

            <!-- Container for the demo -->
            <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--12-col mdl-cell--12-col-tablet mdl-cell--12-col-desktop">
                <div class="mdl-card__title mdl-color--orange-200">
                    <h2 class="mdl-card__title-text">Google Authentication</h2>
                </div>
                <div class="mdl-card__supporting-text mdl-color-text--grey-600">
                    <p>Sign in with your Google account below.</p>
                    <!-- [START google_button] -->
                    <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
                    <!-- [END google_button] -->
                    <br>
                    <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="signout" name="signout">Sign Out</button>
                </div>
            </div>

        </div>
    </main>
</div>
</body>
</html>
