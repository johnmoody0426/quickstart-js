<!DOCTYPE html>
<!--
Copyright (c) 2016 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
<head>
  <meta charset=utf-8 />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--
    Note that Google Sign In does not work from a file URL. You will need to make
    this page available from a web server, either from localhost or using Firebase
    Hosting.

    Whichever domain it is running on, you'll have to add the origin for that domain
    in the Google Developer Console: https://console.developers.google.com, search
    for Credentials and create a new credential > OAuth client ID > web application,
    and set the domain as an authorised origin (e.g. http://localhost:8000 or https://foo.bar).
    -->
  <!-- [START google_config] -->
  <meta name="google-signin-scope" content="profile email">
  <!--
   * TODO(DEVELOPER): Change this config variable. *
   -->
  <meta name="google-signin-client_id" content="YOUR_CLIENT_ID_HERE">
  <meta name="google-signin-cookiepolicy" content="single_host_origin">
  <!-- [END google_config] -->
  <title>Google Sign In Example</title>

  <!-- Material Design Theming -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.1.2/material.orange-indigo.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script defer src="https://code.getmdl.io/1.1.2/material.min.js"></script>

  <!-- Google Sign In -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>

  <!-- Firebase Auth -->
  <script type="text/javascript">
    /**************************************************
     * TODO(DEVELOPER): Change these config variable. *
     **************************************************/
    var apiKey = 'YOUR_API_KEY_HERE';
    var databaseUrl = 'YOUR_DATABASE_URL_HERE';
    // Also remember to change the Google Client ID above!
  </script>
  <script src="https://www.gstatic.com/firebasejs/staging/3.0.0-eap.2/firebase.js"></script>
  <script type="text/javascript">
    console.log('Initializing App');
    // [START appconfig]
    // Api key in config.
    var config = {
      apiKey: apiKey,
      databaseUrl: databaseUrl
    };
    var app = firebase.App.initialize(config);
    var auth = app.auth();
    // [END appconfig]

    function onSignIn(googleUser) {
      // [START checksameuser]
      if (auth.currentUser) {
        // If we are already signed in with Google and Firebase,
        // check we're in a Firebase account associated with the same
        // Google account.
        var providerData = auth.currentUser.getProviderData();
        for (var key in providerData) {
          if (providerData[key].providerId === 'google.com') {
            var mungedId = 'https://accounts.google.com/' + googleUser.getBasicProfile().getId();
            if (providerData[key].userId == mungedId) {
              // We don't need to reauth the Firebase connection.
              return;
            }

          }
        }
      }
      // [END checksameuser]

      // [START googlecredential]
      // Sign in with credential from the Google user.
      var credential = firebase.GoogleAuthProvider.credential({
        'idToken' : googleUser.getAuthResponse().id_token
      });
      // [END googlecredential]
      // [START authwithcred]
      auth.signInWithCredential(credential).then(function(user) {
        console.log('Sign In Success', user);
      }, function(error) {
        console.error('Sign In Error', error);
      });
      // [END authwithcred]
    }

    /*
     * Handle the sign in button press.
     *
     * Sign in status persists between page reloads, so we check status using
     * |currentUser| on the Firebase auth object.
     *
     * auth.signOut clears the current session.
     */
    function handleSignOut() {
      if (auth.currentUser) {
        // [START signout]
        auth.signOut().then(function() {
          // Signout complete.
          console.log('Signed Out');
        }, function(error) {
          console.error('Sign Out Error', error);
        });
        // [END signout]
      }
    }

    /**
     * initApp handles setting up the Firebase context and registering
     * callbacks for the auth status.
     *
     * The core initialization is in firebase.App - this is the glue class
     * which stores configuration. We provide an app name here to allow
     * distinguishing multiple app instances.
     *
     * This method also registers a listener with app.addAuthStateListener.
     * This listener is called when the user is signed in or out, and that
     * is where we update the UI.
     *
     * When signed in, we also authenticate to the Firebase Realtime Database.
     */
    function initApp() {
      // Check preconditions.
      if (databaseUrl.indexOf('firebaseio') < 0 || apiKey.indexOf('AI') < 0) {
        console.log('Enter your config values for apiKey and databaseUrl');
        alert('Enter your config values for apiKey and databaseUrl');
        return;
      }

      console.log('Adding auth state listener');
      // Auth state changes.
      // [START authstatelistener]
      app.addAuthStateListener(function(event) {
        // Current user.
        var user = event.user;
        var getToken = event.getToken;
        console.log('User Object:', user);

        if (!user) {
          document.getElementById('signout').disabled = true;
          return;
        }
        document.getElementById('signout').disabled = false;
        alert('Welcome UID:' + user.uid);

        // [START_EXCLUDE]
        var myFirebaseRef = app.database().ref();
        myFirebaseRef.on('value', function(snapshot) {
          console.log('Database snapshot:', snapshot.val());
        });
        // [END_EXCLUDE]
      }, function(error) {
        console.error('Auth Listener Error', error);
      });
      // [END authstatelistener]

      document.getElementById('signout').addEventListener('click', handleSignOut, false);
    }

    window.onload = function() {
      initApp();
    };
  </script>
</head>
<body>
  <div class="mdl-layout" id="content">
    <header class="mdl-layout__header mdl-grid">
      <h1>Firebase Google Authentication</h1>
    </header>
    <main class="mdl-layout__content">
      <div class="mdl-grid">
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-cell mdl-cell-8-col-tablet mdl-cell--8-col-desktop" >
          <p>Sign in with your Google account below.</p>
        </div>
        <div class="mdl-layout-spacer"></div>
      </div>
      <div class="mdl-grid">
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-cell mdl-cell-8-col-tablet mdl-cell--8-col-desktop" style=>
          <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
          <button id="signout" name="signout">Sign Out</button>
        </div>
        <div class="mdl-layout-spacer"></div>
      </div>
  </main>
  </div>
</body>
</html>
